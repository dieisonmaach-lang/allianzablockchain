<!DOCTYPE html>
<html lang="{{ lang or 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('public_tests') or 'Public Tests - Allianza Testnet' }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Bot√£o Voltar Padronizado */
                .btn-back {
            display: inline-block;
            padding: 8px 16px;
            background: #374151;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        
        
    
        .btn-back:hover {
            background: #4b5563;
        }
</style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <div class="mb-6">
            <a href="javascript:history.back()" class="btn-back">
{{ t('back') or 'Back' }}
            </a>
        </div>

        <h1 class="text-4xl font-bold mb-2">üß™ {{ t('public_tests') or 'Public Tests' }}</h1>
        <p class="text-gray-400 mb-8">{{ t('public_tests_subtitle') or 'Execute real tests and see results in real time' }}</p>

        <!-- Bot√£o Executar Todos -->
        <div class="bg-blue-900 p-6 rounded-lg mb-6">
            <button id="runAllTestsBtn" class="bg-blue-600 hover:bg-blue-700 px-8 py-4 rounded-lg font-semibold text-lg transition">
                <i class="fas fa-play mr-2"></i>{{ t('execute_all_tests') or 'Execute All Tests' }}
            </button>
            <p class="text-sm text-gray-300 mt-2">{{ t('execute_5_main_tests') or 'Execute the 5 main tests and see detailed results' }}</p>
        </div>

        <!-- Testes Individuais -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">1. QRS-3 Signature</h3>
                <button onclick="runTest('qrs3')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm">
                    {{ t('execute') or 'Execute' }}
                </button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">2. {{ t('interoperability') or 'Interoperability' }}</h3>
                <button onclick="runTest('interoperability')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm">
                    {{ t('execute') or 'Execute' }}
                </button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">3. Performance</h3>
                <button onclick="runTest('performance')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm">
                    {{ t('execute') or 'Execute' }}
                </button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">4. {{ t('block_validation') or 'Block Validation' }}</h3>
                <button onclick="runTest('block_validation')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm">
                    {{ t('execute') or 'Execute' }}
                </button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">5. {{ t('quantum_security') or 'Quantum Security' }}</h3>
                <button onclick="runTest('quantum_security')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm">
                    {{ t('execute') or 'Execute' }}
                </button>
            </div>
        </div>

        <!-- Logs em Tempo Real -->
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-2xl font-semibold mb-4">üìã {{ t('real_time_logs') or 'Real-Time Logs' }}</h2>
            <div id="logsContainer" class="bg-gray-900 p-4 rounded font-mono text-sm max-h-96 overflow-y-auto">
                <p class="text-gray-500">{{ t('waiting_test_execution') or 'Waiting for test execution...' }}</p>
            </div>
        </div>

        <!-- Resultados -->
        <div id="resultsContainer" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold">üìä {{ t('results') or 'Results' }}</h2>
                <div class="flex gap-2">
                    <button onclick="copyPublicResults()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-semibold transition">
                        <i class="fas fa-copy mr-2"></i>{{ t('copy') or 'Copy' }}
                    </button>
                    <button onclick="downloadPublicResults()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-semibold transition">
                        <i class="fas fa-download mr-2"></i>{{ t('download') or 'Download' }}
                    </button>
                </div>
            </div>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        function addLog(message, type = 'info') {
            const container = document.getElementById('logsContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400'
            };
            
            const logEntry = document.createElement('p');
            logEntry.className = colors[type] || 'text-gray-300';
            logEntry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        function runTest(testName) {
            addLog(`Iniciando teste: ${testName}...`, 'info');
            
            fetch('/api/public-tests/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({test_name: testName})
            })
            .then(async r => {
                // Verificar se a resposta √© JSON
                const contentType = r.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await r.text();
                    throw new Error(`Resposta n√£o √© JSON. Status: ${r.status}. Resposta: ${text.substring(0, 200)}`);
                }
                return r.json();
            })
            .then(data => {
                if (data.success) {
                    addLog(`‚úÖ Teste ${testName} conclu√≠do!`, 'success');
                    displayResult(data);
                } else {
                    addLog(`‚ùå Erro: ${data.error || 'Erro desconhecido'}`, 'error');
                    displayResult(data);
                }
            })
            .catch(e => {
                addLog(`‚ùå Erro: ${e.message}`, 'error');
                console.error('Erro completo:', e);
            });
        }

        function runAllTests() {
            const btn = document.getElementById('runAllTestsBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Executando...';
            
            document.getElementById('logsContainer').innerHTML = '';
            addLog('üöÄ Iniciando todos os testes...', 'info');
            
            fetch('/api/public-tests/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            })
            .then(async r => {
                // Verificar se a resposta √© JSON
                const contentType = r.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await r.text();
                    throw new Error(`Resposta n√£o √© JSON. Status: ${r.status}. Resposta: ${text.substring(0, 200)}`);
                }
                return r.json();
            })
            .then(data => {
                if (data.success) {
                    addLog(`‚úÖ Todos os testes conclu√≠dos! Taxa de sucesso: ${data.success_rate_percent || 0}%`, 'success');
                    displaySummary(data);
                } else {
                    addLog(`‚ùå Alguns testes falharam: ${data.error || 'Erro desconhecido'}`, 'error');
                    if (data) displaySummary(data);
                }
            })
            .catch(e => {
                addLog(`‚ùå Erro: ${e.message}`, 'error');
                console.error('Erro completo:', e);
            })
            .finally(() => {
                btn.disabled = false;
                const executeText = typeof t !== 'undefined' && t ? t('execute_all_tests') : 'Execute All Tests';
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>' + executeText;
            });
        }

        // Armazenar dados para copiar/baixar
        let currentResultsData = null;

        function displayResult(result) {
            currentResultsData = result;
            const container = document.getElementById('resultsContent');
            container.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4">${result.test_name}</h3>
                    <pre class="bg-gray-900 p-4 rounded text-sm overflow-x-auto">${JSON.stringify(result.results, null, 2)}</pre>
                </div>
            `;
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        function displaySummary(summary) {
            currentResultsData = summary;
            const container = document.getElementById('resultsContent');
            let html = `
                <div class="bg-gray-800 p-6 rounded-lg mb-4">
                    <h3 class="text-xl font-semibold mb-4">Resumo Geral</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-700 p-4 rounded">
                            <p class="text-sm text-gray-400">Taxa de Sucesso</p>
                            <p class="text-3xl font-bold text-green-400">${summary.success_rate_percent}%</p>
                        </div>
                        <div class="bg-gray-700 p-4 rounded">
                            <p class="text-sm text-gray-400">Testes Passaram</p>
                            <p class="text-3xl font-bold text-blue-400">${summary.successful_tests}/${summary.total_tests}</p>
                        </div>
                        <div class="bg-gray-700 p-4 rounded">
                            <p class="text-sm text-gray-400">Tempo Total</p>
                            <p class="text-3xl font-bold text-purple-400">${(summary.total_time_ms/1000).toFixed(2)}s</p>
                        </div>
                    </div>
                </div>
            `;
            
            summary.tests.forEach(test => {
                html += `
                    <div class="bg-gray-800 p-4 rounded-lg mb-2">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold">${test.test_name}</h4>
                            <span class="px-3 py-1 rounded ${test.success ? 'bg-green-600' : 'bg-red-600'}">
                                ${test.success ? '‚úÖ' : '‚ùå'}
                            </span>
                        </div>
                        <pre class="bg-gray-900 p-3 rounded text-xs overflow-x-auto">${JSON.stringify(test.results, null, 2)}</pre>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        // Fun√ß√µes para copiar e baixar resultados p√∫blicos
        function copyPublicResults() {
            const content = currentResultsData ? JSON.stringify(currentResultsData, null, 2) : document.getElementById('resultsContent').innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('‚úÖ Resultados copiados para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar. Tente selecionar e copiar manualmente.');
            });
        }

        function downloadPublicResults() {
            const content = currentResultsData ? JSON.stringify(currentResultsData, null, 2) : document.getElementById('resultsContent').innerText;
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prova_testes_publicos_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('runAllTestsBtn').addEventListener('click', runAllTests);
    </script>
</body>
</html>




