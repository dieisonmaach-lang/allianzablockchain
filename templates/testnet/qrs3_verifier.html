<!DOCTYPE html>
<html lang="{{ lang or 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>üîê {{ t('qrs3_verifier') or 'QRS-3 Verifier - Allianza Testnet' }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/testnet-modern.css">
    <script src="/static/js/testnet-modals.js"></script>
    <style>
        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid #4b5563;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .btn-back:hover {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .main-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        .main-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(147, 51, 234, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(147, 51, 234, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .input-modern {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            color: white;
            transition: all 0.2s;
        }
        .input-modern:focus {
            outline: none;
            border-color: #9333ea;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }
        @media (max-width: 768px) {
            .main-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800 text-white min-h-screen">
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8 max-w-4xl">
        <!-- Header -->
        <div class="mb-8">
            <a href="javascript:history.back()" class="btn-back mb-4 inline-flex">
                <i class="fas fa-arrow-left"></i>
                <span>{{ t('back') or 'Back' }}</span>
            </a>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center text-2xl">
                    üîê
                </div>
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">{{ t('qrs3_verifier') or 'QRS-3 Verifier' }}</h1>
                    <p class="text-gray-400 text-sm mt-1">{{ t('verify_qrs3_signatures') or 'Verify QRS-3 quantum signatures (ECDSA + ML-DSA + SPHINCS+)' }}</p>
                </div>
            </div>
        </div>

        <!-- Gerar Exemplo -->
        <div class="main-card mb-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-magic text-purple-400 text-xl"></i>
                </div>
                <h2 class="text-2xl font-bold">üß™ {{ t('generate_example') or 'Generate Example' }}</h2>
            </div>
            <p class="text-gray-300 mb-4">{{ t('dont_know_how_to_test') or 'Don\'t know how to test? Generate an example QRS-3 message and signature that you can verify.' }}</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">{{ t('example_message_optional') or 'Example Message (optional)' }}</label>
                    <input type="text" id="exampleMessage" placeholder="Hello Allianza Testnet!" 
                           class="input-modern w-full">
                </div>
                <button id="generateExampleBtn" class="btn-primary w-full">
                    <i class="fas fa-magic mr-2"></i>{{ t('generate_example_qrs3_signature') or 'Generate Example QRS-3 Signature' }}
                </button>
            </div>
            <div id="exampleResult" class="mt-4 hidden"></div>
        </div>

        <!-- Verificar Assinatura -->
        <div class="main-card">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-shield-alt text-blue-400 text-xl"></i>
                </div>
                <h2 class="text-2xl font-bold">{{ t('verify_qrs3_signature') or 'Verify QRS-3 Signature' }}</h2>
            </div>
            <form id="verifyForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">{{ t('message') or 'Message' }}</label>
                    <textarea id="message" rows="4" placeholder="{{ t('enter_original_message') or 'Enter the original message...' }}"
                              class="input-modern w-full resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">{{ t('qrs3_signature_json') or 'QRS-3 Signature (JSON)' }}</label>
                    <textarea id="signature" rows="8" placeholder='{"ecdsa": {...}, "ml_dsa": {...}, "sphincs": {...}}'
                              class="input-modern w-full font-mono text-xs resize-none"></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">
                    <i class="fas fa-shield-alt mr-2"></i>{{ t('verify_signature') or 'Verify Signature' }}
                </button>
            </form>
            <div id="result" class="mt-4 hidden"></div>
        </div>
    </div>

    <script>
        // Gerar Exemplo
        document.getElementById('generateExampleBtn').addEventListener('click', async () => {
            const btn = document.getElementById('generateExampleBtn');
            const resultDiv = document.getElementById('exampleResult');
            const exampleMessage = document.getElementById('exampleMessage').value || 'Hello Allianza Testnet!';
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<p class="text-purple-400"><i class="fas fa-spinner fa-spin mr-2"></i>Gerando assinatura QRS-3...</p>';
            
            try {
                const response = await fetch('/api/qrs3/generate-example', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: exampleMessage})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Preencher campos automaticamente
                    document.getElementById('message').value = data.message;
                    document.getElementById('signature').value = JSON.stringify(data.signature, null, 2);
                    
                    resultDiv.innerHTML = `
                        <div class="bg-green-500/20 border border-green-500 rounded-lg p-4">
                            <p class="text-green-400 font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-check-circle"></i>
                                ‚úÖ ${typeof t !== 'undefined' && t ? t('example_generated_success') : 'Example Generated Successfully!'}
                            </p>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <p class="text-gray-300 font-medium mb-1">${typeof t !== 'undefined' && t ? t('message') : 'Message'}:</p>
                                    <p class="font-mono bg-gray-900/50 p-2 rounded border border-gray-700">${data.message}</p>
                                </div>
                                <div>
                                    <p class="text-gray-300 font-medium mb-1">${typeof t !== 'undefined' && t ? t('verification_status') : 'Verification Status'}:</p>
                                    <p class="text-green-400 font-semibold">${data.verified ? '‚úÖ ' + (typeof t !== 'undefined' && t ? t('valid_signature') : 'Valid') : '‚ùå ' + (typeof t !== 'undefined' && t ? t('invalid_signature') : 'Invalid')}</p>
                                </div>
                                ${data.instructions ? `
                                <div class="bg-blue-500/20 border border-blue-500 rounded-lg p-3">
                                    <p class="text-blue-300 font-medium mb-2">${typeof t !== 'undefined' && t ? t('instructions') : 'Instructions'}:</p>
                                    <ul class="text-xs text-blue-200 space-y-1 list-disc list-inside">
                                        ${data.instructions ? data.instructions.map(i => {
                                            // Traduzir instru√ß√µes se dispon√≠vel
                                            if (typeof t !== 'undefined' && t) {
                                                if (i.includes('Copie a mensagem')) return `<li>${t('copy_message_above') || i}</li>`;
                                                if (i.includes('Copie a assinatura')) return `<li>${t('copy_complete_json_signature') || i}</li>`;
                                                if (i.includes('Cole no Verificador')) return `<li>${t('paste_qrs3_verifier') || i}</li>`;
                                                if (i.includes('Clique em')) return `<li>${t('click_verify_signature') || i}</li>`;
                                                if (i.includes('Deve mostrar')) return `<li>${t('should_show_valid') || i}</li>`;
                                            }
                                            return `<li>${i}</li>`;
                                        }).join('') : ''}
                                    </ul>
                                </div>
                                ` : ''}
                                <p class="text-yellow-400 text-xs mt-3 flex items-center gap-2">
                                    <i class="fas fa-lightbulb"></i>
                                    üí° ${typeof t !== 'undefined' && t ? t('fields_auto_filled') : 'Fields were automatically filled. Click "Verify Signature" to test!'}
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-500/20 border border-red-500 rounded-lg p-4">
                            <p class="text-red-400 flex items-center gap-2">
                                <i class="fas fa-times-circle"></i>
                                ‚ùå ${data.error}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="bg-red-500/20 border border-red-500 rounded-lg p-4">
                        <p class="text-red-400 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            ‚ùå ${typeof t !== 'undefined' && t ? t('error') : 'Error'}: ${error.message}
                        </p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                const generateText = typeof t !== 'undefined' && t ? t('generate_example_qrs3_signature') : 'Generate Example QRS-3 Signature';
                btn.innerHTML = '<i class="fas fa-magic mr-2"></i>' + generateText;
            }
        });
        
        // Verificar Assinatura
        document.getElementById('verifyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('message').value;
            const signatureText = document.getElementById('signature').value;
            const resultDiv = document.getElementById('result');
            
            resultDiv.classList.remove('hidden');
            const verifyingText = typeof t !== 'undefined' && t ? t('verifying') : 'Verifying...';
            resultDiv.innerHTML = '<p class="text-blue-400 flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i>' + verifyingText + '</p>';
            
            try {
                const signature = JSON.parse(signatureText);
                
                const response = await fetch('/api/qrs3/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message, signature})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.verified) {
                        // Usar modal moderno para mostrar resultado
                        const resultType = 'success';
                        const validTitle = typeof t !== 'undefined' && t ? t('valid_signature') : 'Valid signature';
                        const validDesc = typeof t !== 'undefined' && t ? t('signature_verified') : 'Signature verified successfully';
                        const description = {
                            statusTitle: validTitle,
                            description: validDesc
                        };
                        
                        // Adicionar detalhes de verifica√ß√£o
                        const verificationDetails = {
                            ecdsa_valid: true,
                            ml_dsa_valid: true,
                            sphincs_valid: true
                        };
                        
                        const dataWithDetails = {
                            ...data,
                            verification_details: verificationDetails
                        };
                        
                        const verifyTitle = typeof t !== 'undefined' && t ? t('qrs3_verification') : 'QRS-3 Verification';
                        createModernModal(verifyTitle, dataWithDetails, resultType, description);
                    } else {
                        const resultType = 'warning';
                        const invalidTitle = typeof t !== 'undefined' && t ? t('invalid_signature') : 'Invalid signature';
                        const invalidDesc = typeof t !== 'undefined' && t ? t('signature_verification_failed') : 'Signature verification failed. Please check if the message and signature are correct.';
                        const description = {
                            statusTitle: invalidTitle,
                            description: invalidDesc
                        };
                        const verifyTitle = typeof t !== 'undefined' && t ? t('qrs3_verification') : 'QRS-3 Verification';
                        createModernModal(verifyTitle, data, resultType, description);
                    }
                    resultDiv.innerHTML = '';
                } else {
                    const resultType = 'error';
                    const description = {
                        statusTitle: 'Erro',
                        description: data.error || 'Erro ao verificar assinatura'
                    };
                    createModernModal('Verifica√ß√£o QRS-3', data, resultType, description);
                    resultDiv.innerHTML = '';
                }
            } catch (error) {
                const errorData = {
                    success: false,
                    error: error.message
                };
                const resultType = 'error';
                const description = {
                    statusTitle: 'Erro ao Processar',
                    description: error.message
                };
                createModernModal('Verifica√ß√£o QRS-3', errorData, resultType, description);
                resultDiv.innerHTML = '';
            }
        });
    </script>
</body>
</html>
